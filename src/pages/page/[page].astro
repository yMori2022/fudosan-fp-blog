---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import PostCard from '@/components/PostCard.astro';

export async function getStaticPaths() {
  const PAGE_SIZE = 10;
  const allPosts = (await getCollection('blog'))
    .filter((p) => !p.data.draft)
    .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

  const totalPages = Math.ceil(allPosts.length / PAGE_SIZE) || 1;

  return Array.from({ length: totalPages }, (_, i) => {
    const page = i + 1;
    const start = (page - 1) * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const posts = allPosts.slice(start, end);
    return {
      params: { page: String(page) },
      props: {
        posts,
        currentPage: page,
        totalPages,
      },
    };
  });
}

const { posts, currentPage, totalPages } = Astro.props;

const pageHref = (n: number) => (n === 1 ? '/' : `/page/${n}/`);
---

<Layout>
  <section class="bg-gradient-to-b from-white to-slate-50 dark:from-zinc-900 dark:to-zinc-950 border-b">
    <div class="mx-auto max-w-3xl px-4 py-14">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900 dark:text-white">ブログ</h1>
      <p class="mt-3 text-slate-600 dark:text-slate-300">最新の記事をお届けします。</p>
    </div>
  </section>

  <main class="mx-auto max-w-3xl px-4 py-10 space-y-6">
    {posts.length === 0 ? (
      <p class="text-slate-600 dark:text-slate-300">このページに表示する記事はありません。</p>
    ) : (
      posts.map((post) => <PostCard post={post} />)
    )}

    {totalPages > 1 && (
      <nav class="pt-4" aria-label="Pagination">
        <div class="flex items-center justify-between gap-2">
          <a href={currentPage > 1 ? pageHref(currentPage - 1) : undefined}
             aria-disabled={currentPage === 1}
             class={`px-3 py-2 rounded border text-sm ${currentPage === 1 ? 'text-slate-400 border-slate-200 cursor-not-allowed' : 'text-slate-700 border-slate-300 hover:bg-slate-50 dark:text-slate-200 dark:border-zinc-700 dark:hover:bg-zinc-800'}`}
          >前へ</a>

          <div class="flex items-center gap-1">
            {Array.from({ length: totalPages }, (_, i) => i + 1).map((n) => (
              <a
                href={pageHref(n)}
                aria-current={n === currentPage ? 'page' : undefined}
                class={`px-3 py-2 rounded text-sm border ${n === currentPage ? 'bg-blue-600 text-white border-blue-600' : 'text-slate-700 border-slate-300 hover:bg-slate-50 dark:text-slate-200 dark:border-zinc-700 dark:hover:bg-zinc-800'}`}
              >
                {n}
              </a>
            ))}
          </div>

          <a href={currentPage < totalPages ? pageHref(currentPage + 1) : undefined}
             aria-disabled={currentPage === totalPages}
             class={`px-3 py-2 rounded border text-sm ${currentPage === totalPages ? 'text-slate-400 border-slate-200 cursor-not-allowed' : 'text-slate-700 border-slate-300 hover:bg-slate-50 dark:text-slate-200 dark:border-zinc-700 dark:hover:bg-zinc-800'}`}
          >次へ</a>
        </div>
      </nav>
    )}
  </main>
  
</Layout>
